# CI workflow for digipin-ts TypeScript project
# This workflow lints, typechecks, tests, and audits the codebase on pushes and pull requests to main.
# It also supports manual triggering via workflow_dispatch.
# It runs on multiple Node.js versions to ensure compatibility.
name: CI â€” digipin-ts

on:
    push:
        branches: [main]
        paths:
            - "src/**/*.ts"
            - "tests/**/*.ts"
            - "package.json"
            - "package-lock.json"
            - "tsconfig*.json"
            - "eslint.config.ts"
    pull_request:
        branches: [main]
        paths:
            - "src/**/*.ts"
            - "tests/**/*.ts"
            - "package.json"
            - "package-lock.json"
            - "tsconfig*.json"
            - "eslint.config.ts"
    workflow_dispatch:

permissions:
    contents: read

jobs:
    test:
        name: Lint, Typecheck, Test, and Audit
        runs-on: ubuntu-latest
        strategy:
            matrix:
                node-version: [20.x, 22.x, 24.x, 25.x]
        steps:
            - name: Checkout
              uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

            - name: Setup Node
              uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6.2.0
              with:
                  node-version: ${{ matrix.node-version }}
                  cache: npm

            - name: Install dependencies (locked)
              run: |
                  set -euo pipefail
                  npm ci

            - name: Lint (eslint)
              run: npm run lint

            - name: Typecheck
              run: npm run typecheck

            - name: Run tests with coverage report
              run: |
                  npm run test:coverage

            - name: npm audit (production deps only)
              run: |
                  npm audit --omit=dev --audit-level=low

            - name: Upload coverage reports to Codecov
              uses: codecov/codecov-action@671740ac38dd9b0130fbe1cec585b89eea48d3de # 5.5.2
              with:
                  token: ${{ secrets.CODECOV_TOKEN }}

            - name: Upload test results to Codecov
              if: ${{ !cancelled() }}
              uses: codecov/test-results-action@0fa95f0e1eeaafde2c782583b36b28ad0d8c77d3 # 1.2.1
              with:
                  token: ${{ secrets.CODECOV_TOKEN }}
